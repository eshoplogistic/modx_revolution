window.onload=function(){let e={items:{getCostResult:{totalCost:"esl_cost",cartCost:"esl-cart-cost",deliveryCost:"esl-delivery-cost",deliveryTime:"esl-delivery-time",deliveryMode:"esl-delivery-mode",addressTitle:"esl-address",fieldTerminal:"esl-address-field-terminal",fieldStreet:"esl-address-field-street",fieldBuilding:"esl-address-field-building",fieldRoom:"esl-address-field-room",paymentNote:"esl-payment-note"},loader:{img:eShopLogisticConfig.assetsUrl+"css/web/loader.svg",deliveryBlocks:"esl-deliveries",loader:"esl-order-block-loading"},activeDelivery:!1,countMode:{terminal:0,door:0}},loader:function(e=null){let t='<img src="'+this.items.loader.img+'">';if(e)e.innerHTML=t;else{let e=document.getElementsByClassName("esl-loader");Array.prototype.filter.call(e,function(e){e.innerHTML=t})}let s=document.querySelectorAll("."+this.items.loader.deliveryBlocks);for(let e of s)e.classList.add("hidden")},msGetCost:function(e){if(!e.serviceName){document.querySelector(".esl-delivery-address").closest(".esl-total-item").classList.add("hidden")}for(const[t,s]of Object.entries(this.items.getCostResult)){let i=document.getElementsByClassName(s);Array.prototype.filter.call(i,function(i){if(_flclst=i.closest(".esl-total-item"),e[t]){let s="";"deliveryCost"==t&&Number(e[t])>0&&(s=" руб."),_flclst&&_flclst.classList.remove("hidden"),i.textContent=e[t]+s}else switch("deliveryCost"!=t&&"deliveryMode"!=t||_flclst&&_flclst.classList.add("hidden"),t){case"addressTitle":e.serviceName&&(i.innerHTML=i.dataset[e.delivery.mode]+" "+e.serviceName);break;case"deliveryTime":e.serviceName||_flclst.classList.add("hidden");break;case"fieldTerminal":e.serviceName&&("terminal"==e.delivery.mode?i.classList.remove("hidden"):i.classList.add("hidden"));break;case"paymentNote":let l=document.getElementsByClassName(s);Array.prototype.filter.call(l,function(e){e.classList.add("hidden")});let a=document.querySelectorAll("."+s+"-"+e.delivery.service);for(let e of a)e.classList.remove("hidden");break;case"fieldStreet":case"fieldBuilding":case"fieldRoom":"terminal"==e.delivery.mode?i.classList.add("hidden"):i.classList.remove("hidden");break;case"totalCost":i.textContent=e.costf}})}if(e.delivery.target){let t=document.getElementById("city"),s=document.getElementById("fias");t&&(t.value=e.delivery.target),s&&(s.value=e.delivery.fias)}},eslGetDeliveries:function(){var e=this;async function t(t,s,i){await e.eslGetDelivery(t,s,i)}this.items.countMode={terminal:"0",door:"0"},this.items.activeDelivery=!1,async function(){let s=document.getElementsByName("delivery"),i=document.getElementById("esl-delivery-empty"),l=document.querySelector("input[name=delivery]:checked").id,a=document.querySelector("input[name=payment]:checked").value,n=document.querySelector("input[name=fias]").value,d=document.getElementById("esl-deliveries-terminal"),o=document.getElementById("esl-deliveries-door"),r=document.getElementById(e.items.loader.loader);r.classList.remove("hidden");for(const e of s){let s={payment:a,service:e.dataset.service,mode:e.dataset.mode,fias:n},i=document.getElementById(s.service+"-"+s.mode);null!==i&&await t(s,i,e)}0==e.items.countMode.terminal&&0==e.items.countMode.door?i.classList.remove("hidden"):(i.classList.add("hidden"),e.items.countMode.terminal>0?d.classList.remove("hidden"):d.classList.add("hidden"),e.items.countMode.door>0?o.classList.remove("hidden"):o.classList.add("hidden")),e.items.activeDelivery||(e.items.activeDelivery=i.querySelector('input[name="delivery"]').id),l==e.items.activeDelivery?miniShop2.Order.getcost():document.getElementById(e.items.activeDelivery).click(),r.classList.add("hidden")}()},eslGetDelivery:function(e,t,s){var i=this;return async function(){return await $.ajax({url:eShopLogisticConfig.actionUrl,type:"POST",data:e,dataType:"json",timeout:5e3})}().then(e=>{if(void 0!==e.service){i.items.activeDelivery||(i.items.activeDelivery=s.id),void 0!==e.mode&&i.items.countMode[e.mode]++;let l='<span class="esl-price">Стоимость: <span'+(1==e.is_free?' class="esl-price-free"':"")+">"+e.price+"</span> "+e.currency+'</span><span class="esl-time">Срок: <span>'+e.time+"</span></span>";null!==e.note&&(l+='<span class="esl-note"><span>'+e.note+"</span></span>"),void 0!==e.terminals&&""!=e.terminals&&(l+="<span class='els-terminals'><a href='#' data-terminals='"+JSON.stringify(e.terminals)+"'>Выбрать пункт самовывоза</a></span>"),t.innerHTML=l,s.closest(".esl-block").classList.remove("hidden")}else s.closest(".esl-block").classList.add("hidden")}).catch(e=>{s.closest(".esl-block").classList.add("hidden")})},search:function(e){_self=this;const t=new XMLHttpRequest;t.open("POST",eShopLogisticConfig.actionUrl,!0),t.responseType="json",t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.send("text="+e),t.addEventListener("readystatechange",()=>{let e="",s=document.getElementById("esl-address-result");if(4===t.readyState&&200===t.status){for(let s in t.response){let i=t.response[s];e+='<a href="#" data-fias="'+i.fias+'" data-city="'+i.target+'" data-index="'+i.index+'">'+i.target+"</a>"}s.innerHTML=e,s.style=""!==e?"display: block":"display: none"}let i=document.querySelectorAll("#esl-address-result a");i.forEach.call(i,function(e){e.addEventListener("click",t=>{t.preventDefault(),_self.loader(),s.innerHTML="";["fias","index","city"].forEach(t=>{let s=document.getElementById(t);s&&(s.value=e.dataset[t],miniShop2.Order.add(t,e.dataset[t]))}),_self.eslGetDeliveries(),s.style="display: none"})})})},setAddress:function(e=!1){let t=document.querySelectorAll(".esl-address-field-terminal, .esl-address"),s=document.querySelectorAll(".els-terminals a"),i=document.querySelector('input[name="terminal"]'),l=document.querySelector("input[name=delivery]:checked"),a=document.querySelector(".esl-delivery-address");if(e){for(let e of t)e.classList.remove("hidden");for(let e of s)e.textContent="Выбрать пункт самовывоза";i.value=e,a&&(a.textContent=e,a.closest(".esl-total-item").classList.remove("hidden"));let n=l.closest(".esl-block");n&&(n.querySelector(".els-terminals a").textContent="Изменить пункт самовывоза")}else{i.value="",a&&(a.textContent="",a.closest(".esl-total-item").classList.add("hidden"));for(let e of s)e.textContent="Выбрать пункт самовывоза";for(let e of t)e.classList.add("hidden")}},reload:function(){this.loader();let e=this;!async function(){await async function(){await e.eslGetDeliveries()}(),miniShop2.Order.getcost()}()}};miniShop2.Callbacks.add("Cart.change.response.success","eShopLogisticCartChange",function(t){e.reload()}),miniShop2.Callbacks.add("Cart.remove.response.success","eShopLogisticCartRemove",function(t){e.reload()}),miniShop2.Callbacks.add("Order.getcost.response.success","eShopLogisticGetCost",function(t){"object"==typeof t.data.delivery&&e.msGetCost(t.data)}),miniShop2.Callbacks.add("Order.add.response.success","eShopLogisticAdd",function(t){"string"==typeof t.data.delivery&&e.setAddress(),1==eShopLogisticConfig.payment_on&&"string"==typeof t.data.payment&&(e.loader(),e.eslGetDeliveries())}),document.getElementById("city").oninput=function(){this.value.length>=3&&e.search(this.value)};let t=document.querySelectorAll(".esl-block");t.forEach.call(t,function(e){e.addEventListener("click",t=>{e.querySelector("[name=delivery]").dispatchEvent(new Event("click"))})}),e.loader(),e.eslGetDeliveries();let s="esl_yandex_map",i={backdrop:null,initLayout:{createRoot:function(){let e=document.createElement("div");return e.classList.add("modal","fade"),e.setAttribute("tabindex","-1"),e.setAttribute("role","dialog"),e.setAttribute("id",s),document.body.appendChild(e),e},createDialog:function(e){let t=document.createElement("div");return t.classList.add("modal-dialog","modal-lg"),document.documentElement.clientWidth<768&&t.setAttribute("style","width: 100%"),e.appendChild(t),t},createContent:function(e){let t=document.createElement("div");return t.classList.add("modal-content"),e.appendChild(t),t},createHeader:function(e){let t=document.createElement("div");return t.classList.add("modal-header"),t.innerHTML="<h4>Пункты самовывоза</h4>",e.appendChild(t),t},createButtonClose:function(e){let t=document.createElement("button");return t.setAttribute("type","button"),t.setAttribute("data-dismiss","modal"),t.setAttribute("aria-label","Close"),t.classList.add("close"),t.addEventListener("click",i.close),e.appendChild(t),t},createIconClose:function(e){let t=document.createElement("span");return t.setAttribute("aria-hidden","true"),t.innerHTML="&times;",e.appendChild(t),t},createBody:function(e){let t=document.createElement("div");return t.classList.add("modal-body"),e.appendChild(t),t},createRow:function(e){let t=document.createElement("div");return t.classList.add("class","row"),e.appendChild(t),t},createColForMap:function(e){let t=document.createElement("div");t.classList.add("col-lg-12","col-md-12"),t.setAttribute("id","esl-modal-yandex-map-wrap"),e.appendChild(t)},createBackDrop:function(){let e=document.createElement("div");e.classList.add("modal-backdrop","fade"),e.setAttribute("style","display: none"),document.body.appendChild(e),i.backdrop=e}},createModalBootstrap:function(){if(this.checkOnInit())return;let e=this.initLayout.createRoot(),t=this.initLayout.createDialog(e),s=this.initLayout.createContent(t),i=this.initLayout.createHeader(s),l=this.initLayout.createButtonClose(i),a=(this.initLayout.createIconClose(l),this.initLayout.createBody(s)),n=this.initLayout.createRow(a);this.initLayout.createColForMap(n);this.initLayout.createBackDrop()},checkOnInit:function(){return!!document.getElementById(this.idModal)},open:function(){let e=document.getElementById(s);document.body.classList.add("modal-open"),document.body.setAttribute("style","padding-right:17px"),i.backdrop.removeAttribute("style"),setTimeout(()=>{e.setAttribute("style","display:block;padding-left:17px"),setTimeout(()=>{e.classList.add("show"),i.backdrop.classList.add("show")},200)},100)},close:function(){let e=document.getElementById(s);e.classList.remove("show"),setTimeout(()=>{i.backdrop.classList.remove("show"),setTimeout(()=>{document.body.classList.remove("modal-open"),document.body.removeAttribute("style"),i.backdrop.setAttribute("style","display: none"),e.removeAttribute("style"),document.dispatchEvent(new CustomEvent("eshoplogistic.hide.modal"))},200)},100)},destroy:function(){this.checkOnInit()&&document.getElementById(this.idModal).remove()}};i.createModalBootstrap();let l={terminals:[],settings:{},initApi:function(){let e=document.createElement("script");e.setAttribute("src","https://api-maps.yandex.ru/2.1/?lang=ru_RU"),e.setAttribute("defer",""),document.head.appendChild(e)},createContainer:function(){let e=document.createElement("div"),t=document.getElementById(s).querySelector(".modal-body  #esl-modal-yandex-map-wrap");e.setAttribute("id","esl_yandex_map_container"),e.setAttribute("style","width: 100%;height:400px"),t.appendChild(e)},initMap:function(e){var t=new ymaps.Map("esl_yandex_map_container",{center:[l.terminals[0].lat,l.terminals[0].lon],zoom:10,controls:["zoomControl"]},{suppressMapOpenBlock:!0});t.behaviors.disable("scrollZoom"),l.createPlacemarks(l.terminals,t)},createPlacemarks:function(e,t){let s=[],l=0;for(const t of e){if(""===t.lat||""===t.lon)continue;const e=ymaps.templateLayoutFactory.createClass('<h3 style="font-size: 1.3em;font-weight: bold;margin-bottom: 0.5em;">{{ properties.address }}</h3><p>{{ properties.note }}</p><p><b>Время работы: {{ properties.timeWork }}</b></p><button type="button" data-accept-terminal class="btn btn-success">Забрать отсюда</button>',{build:function(){e.superclass.build.call(this);const t=document.getElementById("esl-modal-yandex-map-wrap").querySelector("[data-accept-terminal]");t&&t.addEventListener("click",this.selectedTerminal)},clear:function(){const t=document.getElementById("esl-modal-yandex-map-wrap").querySelector("[data-accept-terminal]");t&&t.removeEventListener("click",this.selectedTerminal),e.superclass.clear.call(this)},selectedTerminal:function(){document.dispatchEvent(new CustomEvent("onSelectAddress",{detail:t})),i.close()}});s[l]=new ymaps.Placemark([t.lat,t.lon],{note:t.note,address:t.address,timeWork:t.workTime?t.workTime:"Не указано"},{balloonContentLayout:e,balloonPanelMaxMapArea:0}),l++}let a=new ymaps.Clusterer({clusterDisableClickZoom:!1});a.add(s),t.geoObjects.add(a)},destroyMap:function(){document.getElementById("esl_yandex_map_container").remove()}};l.initApi();let a=function(e){let t=e.target.closest(".esl-block");if(t&&t.querySelector("input").click(),e.target.closest(".els-terminals")){e.preventDefault();let t=e.target.getAttribute("data-terminals");t&&(l.createContainer(),l.terminals=JSON.parse(t),ymaps.ready(l.initMap),i.open())}},n=function(){l.destroyMap()};document.addEventListener("click",a,!1),document.addEventListener("eshoplogistic.hide.modal",n),document.addEventListener("onSelectAddress",function(t){e.setAddress(t.detail.address)})};